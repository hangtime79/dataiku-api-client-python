{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://dataiku.com/schemas/reusable-workflows/block-manifest.schema.json",
  "title": "Block Manifest",
  "description": "Schema for a block manifest in BLOCKS_REGISTRY (created by Discovery Agent)",
  "type": "object",
  "required": ["block_id", "version", "type", "name", "source_project"],
  "properties": {
    "block_id": {
      "type": "string",
      "description": "Unique identifier for the block (uppercase with underscores)",
      "pattern": "^[A-Z][A-Z0-9_]*$",
      "examples": ["FEATURE_ENG", "ANOMALY_DETECTION", "COMPRESSOR_MONITORING"]
    },
    "version": {
      "type": "string",
      "description": "Semantic version of the block",
      "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+$",
      "examples": ["1.0.0", "1.2.3", "2.0.0"]
    },
    "type": {
      "type": "string",
      "description": "Block type",
      "enum": ["zone", "solution"],
      "default": "zone"
    },
    "blocked": {
      "type": "boolean",
      "description": "Whether the block is protected/published (true = stable, production-ready)",
      "default": false
    },
    "name": {
      "type": "string",
      "description": "Human-readable name for the block",
      "examples": ["Feature Engineering Block", "Anomaly Detection"]
    },
    "description": {
      "type": "string",
      "description": "Detailed description of what the block does"
    },
    "hierarchy_level": {
      "type": "string",
      "description": "ISA-95 hierarchy level",
      "enum": ["sensor", "equipment", "process", "plant", "business"],
      "examples": ["equipment", "process"]
    },
    "domain": {
      "type": "string",
      "description": "Business/technical domain",
      "examples": ["rotating_equipment", "process_control", "predictive_maintenance", "quality_control"]
    },
    "tags": {
      "type": "array",
      "description": "Searchable tags for the block",
      "items": {
        "type": "string"
      },
      "examples": [["compressor", "vibration", "fft", "feature_engineering"]]
    },
    "source_project": {
      "type": "string",
      "description": "Project key where this block was extracted from",
      "pattern": "^[A-Z][A-Z0-9_]*$"
    },
    "source_zone": {
      "type": "string",
      "description": "Zone name in the source project"
    },
    "inputs": {
      "type": "array",
      "description": "Input ports for the block",
      "items": {
        "$ref": "#/definitions/port"
      }
    },
    "outputs": {
      "type": "array",
      "description": "Output ports for the block",
      "items": {
        "$ref": "#/definitions/port"
      }
    },
    "contains": {
      "type": "object",
      "description": "Resources contained within the block",
      "properties": {
        "datasets": {
          "type": "array",
          "description": "Internal datasets",
          "items": {"type": "string"}
        },
        "recipes": {
          "type": "array",
          "description": "Recipes in the block",
          "items": {"type": "string"}
        },
        "scenarios": {
          "type": "array",
          "description": "Scenarios (if any)",
          "items": {"type": "string"}
        }
      }
    },
    "dependencies": {
      "type": "object",
      "description": "External dependencies",
      "properties": {
        "python_packages": {
          "type": "array",
          "items": {"type": "string"},
          "examples": [["numpy>=1.20", "pandas>=1.3", "scikit-learn>=1.0"]]
        },
        "connections": {
          "type": "array",
          "description": "Required connection types",
          "items": {"type": "string"},
          "examples": [["SQL", "filesystem"]]
        },
        "code_envs": {
          "type": "array",
          "description": "Required code environment names or specs",
          "items": {"type": "string"}
        }
      }
    },
    "extension_points": {
      "type": "array",
      "description": "Recipes that support extension via class override",
      "items": {
        "$ref": "#/definitions/extensionPoint"
      }
    },
    "metadata": {
      "type": "object",
      "description": "Additional metadata",
      "properties": {
        "created_at": {
          "type": "string",
          "format": "date-time"
        },
        "created_by": {
          "type": "string"
        },
        "updated_at": {
          "type": "string",
          "format": "date-time"
        },
        "documentation_url": {
          "type": "string",
          "format": "uri"
        }
      }
    }
  },
  "definitions": {
    "port": {
      "type": "object",
      "description": "Input or output port definition",
      "required": ["name"],
      "properties": {
        "name": {
          "type": "string",
          "description": "Port name (matches dataset name in block)",
          "pattern": "^[A-Z][A-Z0-9_]*$"
        },
        "type": {
          "type": "string",
          "description": "Type of port",
          "enum": ["dataset", "folder", "model"],
          "default": "dataset"
        },
        "required": {
          "type": "boolean",
          "description": "Whether this input is required",
          "default": true
        },
        "description": {
          "type": "string",
          "description": "Description of what this port expects/produces"
        },
        "schema_ref": {
          "type": "string",
          "description": "Reference to schema file in registry"
        },
        "expected_columns": {
          "type": "array",
          "description": "Expected column names (for datasets)",
          "items": {
            "type": "object",
            "properties": {
              "name": {"type": "string"},
              "type": {"type": "string"},
              "required": {"type": "boolean", "default": true}
            }
          }
        }
      }
    },
    "extensionPoint": {
      "type": "object",
      "description": "Recipe that supports class extension",
      "required": ["recipe", "base_class"],
      "properties": {
        "recipe": {
          "type": "string",
          "description": "Recipe name that supports extension"
        },
        "base_class": {
          "type": "string",
          "description": "Fully qualified name of the base class to extend"
        },
        "description": {
          "type": "string",
          "description": "What the extension point allows customizing"
        },
        "required_methods": {
          "type": "array",
          "description": "Methods that must be implemented",
          "items": {"type": "string"}
        }
      }
    }
  },
  "examples": [
    {
      "block_id": "COMPRESSOR_FEATURE_ENG",
      "version": "1.2.0",
      "type": "zone",
      "blocked": true,
      "name": "Compressor Feature Engineering",
      "description": "Extracts vibration features from compressor sensor data using FFT analysis",
      "hierarchy_level": "equipment",
      "domain": "rotating_equipment",
      "tags": ["compressor", "vibration", "fft", "feature_engineering"],
      "source_project": "COMPRESSOR_ANALYTICS",
      "source_zone": "feature_engineering_zone",
      "inputs": [
        {
          "name": "RAW_VIBRATION",
          "type": "dataset",
          "required": true,
          "description": "Raw vibration sensor readings",
          "expected_columns": [
            {"name": "TIMESTAMP", "type": "date", "required": true},
            {"name": "SENSOR_ID", "type": "string", "required": true},
            {"name": "VALUE", "type": "double", "required": true}
          ]
        },
        {
          "name": "EQUIPMENT_METADATA",
          "type": "dataset",
          "required": false,
          "description": "Equipment metadata for contextualization"
        }
      ],
      "outputs": [
        {
          "name": "VIBRATION_FEATURES",
          "type": "dataset",
          "description": "Computed vibration features including FFT components"
        }
      ],
      "contains": {
        "datasets": ["RAW_VIBRATION", "SMOOTHED_SIGNAL", "FFT_COMPONENTS", "VIBRATION_FEATURES"],
        "recipes": ["signal_smoothing", "fft_compute", "feature_aggregation"]
      },
      "dependencies": {
        "python_packages": ["numpy>=1.20", "scipy>=1.7"],
        "connections": ["filesystem"]
      },
      "extension_points": [
        {
          "recipe": "feature_aggregation",
          "base_class": "blocks.features.BaseFeatureAggregator",
          "description": "Custom feature aggregation logic",
          "required_methods": ["aggregate"]
        }
      ],
      "metadata": {
        "created_at": "2024-01-15T10:30:00Z",
        "created_by": "data_engineer@company.com",
        "documentation_url": "https://docs.internal/blocks/compressor-features"
      }
    }
  ]
}
